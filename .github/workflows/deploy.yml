name: Deploy to EC2

on:
  push:
    branches: ["main"]

concurrency:
  group: deploy-main
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Build frontend
        working-directory: frontend
        run: |
          npm ci
          npm run build

      - name: Setup SSH
        run: |
          set -e
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          echo "Host=${{ secrets.EC2_HOST }}"
          ssh-keyscan -T 10 -H "${{ secrets.EC2_HOST }}" >> ~/.ssh/known_hosts

      # Backend: pull/install/migrate/restart + healthcheck retry
      - name: Deploy backend (pull/install/migrate/restart)
        run: |
          ssh "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}" << 'EOF'
            set -euo pipefail

            cd /opt/app/sesac-semi
            git fetch origin
            git reset --hard origin/main
            git clean -fd

            cd backend
            source .venv/bin/activate
            pip install -r requirements.txt

            # DB migration (needs DATABASE_URL)
            set -a
            source /etc/default/backend
            set +a
            alembic upgrade head

            sudo systemctl restart backend

            # Healthcheck retry (wait for backend to bind 127.0.0.1:8000)
            for i in {1..20}; do
              if curl -fsS http://127.0.0.1:8000/api/health >/dev/null; then
                echo "backend health ok"
                break
              fi
              sleep 1
            done

            # Final check (fail if still down)
            curl -fsS http://127.0.0.1:8000/api/health >/dev/null
          EOF

      - name: Upload frontend dist
        run: |
          rsync -az --delete frontend/dist/ "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/tmp/frontend-dist/"

      - name: Activate frontend dist
        run: |
          ssh "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}" << 'EOF'
            set -euo pipefail
            sudo mkdir -p /var/www/intra-board
            sudo rm -rf /var/www/intra-board/*
            sudo mv /tmp/frontend-dist/* /var/www/intra-board/
            sudo chown -R www-data:www-data /var/www/intra-board
            sudo find /var/www/intra-board -type d -exec chmod 755 {} \;
            sudo find /var/www/intra-board -type f -exec chmod 644 {} \;
            sudo nginx -t
            sudo systemctl reload nginx
          EOF
